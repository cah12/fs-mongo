"use strict";!function($,window,document,undefined){var single;$.single=(single=$({}),function(elm){return single[0]=elm,single}),$.fn.contextMenu=function(method,selector,option){methods[method]?selector&&(selector instanceof Array||"string"==typeof selector||selector.nodeType||selector.jquery||(option=selector,selector=null)):(option=selector,selector=method,method="popup"),selector instanceof Array&&"update"!=method&&(method="menu");var myoptions=option;return $.inArray(method,["menu","popup","close","destroy"])>-1?(option=iMethods.optionOtimizer(method,option),this.each((function(){var $this=$(this);(myoptions=$.extend({},$.fn.contextMenu.defaults,option)).baseTrigger||(myoptions.baseTrigger=$this),methods[method].call($this,selector,myoptions)}))):methods[method].call(this,selector,myoptions),this},$.fn.contextMenu.defaults={triggerOn:"click",subMenuTriggerOn:"hover click",displayAround:"cursor",mouseClick:"left",verAdjust:0,horAdjust:0,top:"auto",left:"auto",closeOther:!0,containment:window,winEventClose:!0,position:"auto",closeOnClick:!0,onOpen:function(data,event){},afterOpen:function(data,event){},onClose:function(data,event){}};var methods={menu:function(selector,option){selector=iMethods.createMenuList(this,selector,option),iMethods.contextMenuBind.call(this,selector,option,"menu")},popup:function(selector,option){$(selector).addClass("iw-contextMenu"),iMethods.contextMenuBind.call(this,selector,option,"popup")},update:function(selector,option){var self=this;option=option||{},this.each((function(){var trgr=$(this),menuData=trgr.data("iw-menuData");menuData||(self.contextMenu("refresh"),menuData=trgr.data("iw-menuData"));var menu=menuData.menu;if("object"==typeof selector)for(var i=0;i<selector.length;i++){var name=selector[i].name,disable=selector[i].disable,fun=selector[i].fun,icon=selector[i].icon,img=selector[i].img,title=selector[i].title,className=selector[i].className,elm=menu.children("li").filter((function(){return $(this).contents().filter((function(){return 3==this.nodeType})).text()==name})),subMenu=selector[i].subMenu;null!=disable&&(disable?elm.addClass("iw-mDisable"):elm.removeClass("iw-mDisable")),fun&&elm.unbind("click.contextMenu").bind("click.contextMenu",fun),null!=title&&elm.attr("title",title),null!=className&&elm.attr("class",className);var imgIcon=elm.find(".iw-mIcon");imgIcon.length&&imgIcon.remove(),img?elm.prepend('<img src="'+img+'" align="absmiddle" class="iw-mIcon" />'):icon&&elm.prepend('<span align="absmiddle" class="iw-mIcon '+icon+'" />'),subMenu&&elm.contextMenu("update",subMenu)}iMethods.onOff(menu);var triggerOn=option.triggerOn;if(triggerOn){trgr.unbind(".contextMenu");for(var events=[],i=0,ln=(triggerOn=triggerOn.split(" ")).length;i<ln;i++)events.push(triggerOn[i]+".contextMenu");trgr.bind(events.join(" "),iMethods.eventHandler)}menuData.option=$.extend({},menuData.option,option),trgr.data("iw-menuData",menuData)}))},refresh:function(){var menuData=this.filter((function(){return!!$(this).data("iw-menuData")})).data("iw-menuData"),newElm=this.filter((function(){return!$(this).data("iw-menuData")}));menuData.option.baseTrigger=this,iMethods.contextMenuBind.call(newElm,menuData.menuSelector,menuData.option)},open:function(sel,data){var e=(data=data||{}).event||$.Event("click");data.top&&(e.clientY=data.top),data.left&&(e.clientX=data.left),this.each((function(){iMethods.eventHandler.call(this,e)}))},close:function(){var menuData=this.data("iw-menuData");menuData&&iMethods.closeContextMenu(menuData.option,this,menuData.menu,null)},value:function(key){var menuData=this.data("iw-menuData");return menuData[key]?menuData[key]:menuData.option?menuData.option[key]:null},destroy:function(){var trgr=this,menuId=this.data("iw-menuData").menuId,menu=$(".iw-contextMenu[menuId="+menuId+"]"),menuData=menu.data("iw-menuData");menuData&&(1==menuData.noTrigger?menu.hasClass("iw-created")?menu.remove():(menu.removeClass("iw-contextMenu "+menuId).removeAttr("menuId").removeData("iw-menuData"),menu.find("li.iw-mTrigger").contextMenu("destroy")):(menuData.noTrigger--,menu.data("iw-menuData",menuData)),this.unbind(".contextMenu").removeClass("iw-mTrigger").removeData("iw-menuData"))}},iMethods={contextMenuBind:function(selector,option,method){var trigger=this,menu=$(selector),menuData=menu.data("iw-menuData");if(0!=menu.length||0!=(menu=trigger.find(selector)).length){"menu"==method&&iMethods.menuHover(menu);var baseTrigger=option.baseTrigger;if(menuData)menuData.noTrigger++,menu.data("iw-menuData",menuData);else{var menuId;baseTrigger.data("iw-menuData")?menuId=baseTrigger.data("iw-menuData").menuId:(menuId=Math.ceil(1e5*Math.random()),baseTrigger.data("iw-menuData",{menuId:menuId}));var cloneMenu=menu.clone();cloneMenu.appendTo("body"),menuData={menuId:menuId,menuWidth:cloneMenu.outerWidth(!0),menuHeight:cloneMenu.outerHeight(!0),noTrigger:1,trigger:trigger},menu.data("iw-menuData",menuData).attr("menuId",menuId),cloneMenu.remove()}trigger.addClass("iw-mTrigger").data("iw-menuData",{menuId:menuData.menuId,option:option,menu:menu,menuSelector:selector,method:method});var triggerOn=option.triggerOn;-1!=triggerOn.indexOf("hover")&&(triggerOn=triggerOn.replace("hover","mouseenter"),-1!=baseTrigger.index(trigger)&&baseTrigger.add(menu).bind("mouseleave.contextMenu",(function(e){0==$(e.relatedTarget).closest(".iw-contextMenu").length&&$('.iw-contextMenu[menuId="'+menuData.menuId+'"]').fadeOut(100)}))),trigger.delegate("input,a,.needs-click","click",(function(e){e.stopImmediatePropagation()}));for(var events=[],i=0,ln=(triggerOn=triggerOn.split(" ")).length;i<ln;i++)events.push(triggerOn[i]+".contextMenu");trigger.bind(events.join(" "),iMethods.eventHandler),menu.bind("click mouseenter",(function(e){e.stopPropagation()})),menu.delegate("li","click",(function(e){option.closeOnClick&&!$.single(this).hasClass("iw-has-submenu")&&iMethods.closeContextMenu(option,trigger,menu,e)}))}},eventHandler:function(e){e.preventDefault();var trigger=$(this),trgrData=trigger.data("iw-menuData"),menu=trgrData.menu,menuData=menu.data("iw-menuData"),option=trgrData.option,cntnmnt=option.containment,clbckData={trigger:trigger,menu:menu},cntWin=cntnmnt==window,btChck=-1==option.baseTrigger.index(trigger);!btChck&&option.closeOther&&$(".iw-contextMenu").css("display","none"),menu.find(".iw-mSelected").removeClass("iw-mSelected"),option.onOpen.call(this,clbckData,e);var cObj=$(cntnmnt),cHeight=cObj.innerHeight(),cWidth=cObj.innerWidth(),cTop=0,cLeft=0,menuHeight=menuData.menuHeight,menuWidth=menuData.menuWidth,va,ha,left=0,top=0,bottomMenu,rightMenu,verAdjust=va=parseInt(option.verAdjust),horAdjust=ha=parseInt(option.horAdjust);if(cntWin||(cTop=cObj.offset().top,cLeft=cObj.offset().left,"static"==cObj.css("position")&&cObj.css("position","relative")),"cursor"==option.displayAround)left=cntWin?e.clientX:e.clientX+$(window).scrollLeft()-cLeft,(bottomMenu=(top=cntWin?e.clientY:e.clientY+$(window).scrollTop()-cTop)+menuHeight)>cHeight&&(top-menuHeight<0?bottomMenu-cHeight<menuHeight-top?(top=cHeight-menuHeight,va*=-1):(top=0,va=0):(top-=menuHeight,va*=-1)),(rightMenu=left+menuWidth)>cWidth&&(left-menuWidth<0?rightMenu-cWidth<menuWidth-left?(left=cWidth-menuWidth,ha*=-1):(left=0,ha=0):(left-=menuWidth,ha*=-1));else if("trigger"==option.displayAround){var triggerHeight=trigger.outerHeight(!0),triggerWidth=trigger.outerWidth(!0),triggerLeft=cntWin?trigger.offset().left-cObj.scrollLeft():trigger.offset().left-cLeft,triggerTop=cntWin?trigger.offset().top-cObj.scrollTop():trigger.offset().top-cTop,leftShift=triggerWidth;(bottomMenu=(top=triggerTop)+menuHeight)>cHeight&&(top-menuHeight<0?bottomMenu-cHeight<menuHeight-top?(top=cHeight-menuHeight,va*=-1):(top=0,va=0):(top=top-menuHeight+triggerHeight,va*=-1)),(rightMenu=(left=triggerLeft+triggerWidth)+menuWidth)>cWidth&&(left-menuWidth<0?rightMenu-cWidth<menuWidth-left?(left=cWidth-menuWidth,ha*=-1,leftShift=-triggerWidth):(left=0,ha=0,leftShift=0):(left=left-menuWidth-triggerWidth,ha*=-1,leftShift=-triggerWidth)),"top"==option.position?(top=triggerTop-menuHeight,va=verAdjust,left-=leftShift):"left"==option.position?(left=triggerLeft-menuWidth,ha=horAdjust):"bottom"==option.position?(top=triggerTop+triggerHeight,va=verAdjust,left-=leftShift):"right"==option.position&&(left=triggerLeft+triggerWidth,ha=horAdjust)}var cssObj={position:cntWin||btChck?"fixed":"absolute",display:"inline-block",height:"",width:""};if("auto"!=option.left&&(left=iMethods.getPxSize(option.left,cWidth)),"auto"!=option.top&&(top=iMethods.getPxSize(option.top,cHeight)),!cntWin){var oParPos=trigger.offsetParent().offset();btChck?(left=left+cLeft-$(window).scrollLeft(),top=top+cTop-$(window).scrollTop()):(left-=cLeft-oParPos.left,top-=cTop-oParPos.top)}cssObj.left=left+ha+"px",cssObj.top=top+va+"px",menu.css(cssObj),option.afterOpen.call(this,clbckData,e),0==trigger.closest(".iw-contextMenu").length&&($(".iw-curMenu").removeClass("iw-curMenu"),menu.addClass("iw-curMenu"));var dataParm={trigger:trigger,menu:menu,option:option,method:trgrData.method};$("html").unbind("click",iMethods.clickEvent).click(dataParm,iMethods.clickEvent),$(document).unbind("keydown",iMethods.keyEvent).keydown(dataParm,iMethods.keyEvent),option.winEventClose&&$(window).bind("scroll resize",dataParm,iMethods.scrollEvent)},scrollEvent:function(e){iMethods.closeContextMenu(e.data.option,e.data.trigger,e.data.menu,e)},clickEvent:function(e){var button;e.data.trigger.get(0)!==e.target&&0==$(e.target).closest(".iw-contextMenu").length&&iMethods.closeContextMenu(e.data.option,e.data.trigger,e.data.menu,e)},keyEvent:function(e){e.preventDefault();var menu=e.data.menu,option=e.data.option,keyCode=e.keyCode;if(27==keyCode&&iMethods.closeContextMenu(option,e.data.trigger,menu,e),"menu"==e.data.method){var curMenu=$(".iw-curMenu"),optList=curMenu.children("li:not(.iw-mDisable)"),selected=optList.filter(".iw-mSelected"),index=optList.index(selected),focusOn=function(elm){var menuData;iMethods.selectMenu(curMenu,elm),elm.data("iw-menuData")&&iMethods.eventHandler.call(elm[0],e)},first=function(){focusOn(optList.filter(":first"))},last=function(){focusOn(optList.filter(":last"))},next=function(){focusOn(optList.filter(":eq("+(index+1)+")"))},prev=function(){focusOn(optList.filter(":eq("+(index-1)+")"))},subMenu=function(){var menuData=selected.data("iw-menuData");if(menuData){iMethods.eventHandler.call(selected[0],e);var selector=menuData.menu;selector.addClass("iw-curMenu"),curMenu.removeClass("iw-curMenu"),optList=(curMenu=selector).children("li:not(.iw-mDisable)"),selected=optList.filter(".iw-mSelected"),first()}},parMenu=function(){var selector,parMenu=curMenu.data("iw-menuData").trigger.closest(".iw-contextMenu");0!=parMenu.length&&(curMenu.removeClass("iw-curMenu").css("display","none"),parMenu.addClass("iw-curMenu"))};switch(keyCode){case 13:selected.click();break;case 40:index==optList.length-1||0==selected.length?first():next();break;case 38:0==index||0==selected.length?last():prev();break;case 33:first();break;case 34:last();break;case 37:parMenu();break;case 39:subMenu()}}},closeContextMenu:function(option,trigger,menu,e){$(document).unbind("keydown",iMethods.keyEvent),$("html").unbind("click",iMethods.clickEvent),$(window).unbind("scroll resize",iMethods.scrollEvent),$(".iw-contextMenu").css("display","none"),$(document).focus(),option.onClose.call(this,{trigger:trigger,menu:menu},e)},getPxSize:function(size,of){return isNaN(size)?-1!=size.indexOf("%")?parseInt(size)*of/100:parseInt(size):size},selectMenu:function(menu,elm){var selected=menu.find("li.iw-mSelected"),submenu=selected.find(".iw-contextMenu");0!=submenu.length&&selected[0]!=elm[0]&&submenu.fadeOut(100),selected.removeClass("iw-mSelected"),elm.addClass("iw-mSelected")},menuHover:function(menu){var lastEventTime=Date.now();menu.children("li").bind("mouseenter.contextMenu click.contextMenu",(function(e){$(".iw-curMenu").removeClass("iw-curMenu"),menu.addClass("iw-curMenu"),iMethods.selectMenu(menu,$(this))}))},createMenuList:function(trgr,selector,option){var baseTrigger=option.baseTrigger,randomNum=Math.floor(1e4*Math.random());if("object"==typeof selector&&!selector.nodeType&&!selector.jquery){var menuList=$('<ul class="iw-contextMenu iw-created iw-cm-menu" id="iw-contextMenu'+randomNum+'"></ul>'),z=option.zIndex||trgr.css("zIndex");if(menuList.css("zIndex",z),$.each(selector,(function(index,selObj){var name=selObj.name,fun=selObj.fun||function(){},subMenu=selObj.subMenu,img=selObj.img||"",icon=selObj.icon||"",title=selObj.title||"",className=selObj.className||"",disable=selObj.disable,list=$('<li title="'+title+'" class="'+className+'">'+name+"</li>");img?list.prepend('<img src="'+img+'" align="absmiddle" class="iw-mIcon" />'):icon&&list.prepend('<span align="absmiddle" class="iw-mIcon '+icon+'" />'),disable&&list.addClass("iw-mDisable"),subMenu||list.bind("click.contextMenu",(function(e){fun.call(this,{trigger:baseTrigger,menu:menuList},e)})),menuList.append(list),subMenu&&(list.addClass("iw-has-submenu").append('<div class="iw-cm-arrow-right" />'),iMethods.subMenu(list,subMenu,baseTrigger,option))})),-1==baseTrigger.index(trgr[0]))trgr.append(menuList);else{var par=option.containment==window?"body":option.containment;$(par).append(menuList)}return iMethods.onOff($("#iw-contextMenu"+randomNum)),"#iw-contextMenu"+randomNum}if(0!=$(selector).length){var element=$(selector);return element.removeClass("iw-contextMenuCurrent").addClass("iw-contextMenu iw-cm-menu iw-contextMenu"+randomNum).attr("menuId","iw-contextMenu"+randomNum).css("display","none"),element.find("ul").each((function(index,element){var subMenu=$(this),parent=subMenu.parent("li");parent.append('<div class="iw-cm-arrow-right" />'),subMenu.addClass("iw-contextMenuCurrent"),iMethods.subMenu(parent,".iw-contextMenuCurrent",baseTrigger,option)})),iMethods.onOff($(".iw-contextMenu"+randomNum)),".iw-contextMenu"+randomNum}},subMenu:function(trigger,selector,baseTrigger,option){trigger.contextMenu("menu",selector,{triggerOn:option.subMenuTriggerOn,displayAround:"trigger",position:"auto",mouseClick:"left",baseTrigger:baseTrigger,containment:option.containment})},onOff:function(menu){menu.find(".iw-mOverlay").remove(),menu.find(".iw-mDisable").each((function(){var list=$(this);list.append('<div class="iw-mOverlay"/>'),list.find(".iw-mOverlay").bind("click mouseenter",(function(event){event.stopPropagation()}))}))},optionOtimizer:function(method,option){if(option)return"menu"==method&&(option.mouseClick||(option.mouseClick="right")),"right"==option.mouseClick&&"click"==option.triggerOn&&(option.triggerOn="contextmenu"),-1!=$.inArray(option.triggerOn,["hover","mouseenter","mouseover","mouseleave","mouseout","focusin","focusout"])&&(option.displayAround="trigger"),option}}}(jQuery,window,document);class FileSystemServices{constructor(_options){const self=this;let inMemoryToken=null,options=_options||{};options.accessTokenExpiry=options.accessTokenExpiry||10;const fsServerUrl=options.fsServerUrl="https://grapher-file-system.herokuapp.com";let currentFilename=null;this.currentFilename=function(filename){return void 0!==filename&&(currentFilename=filename),currentFilename};const listOfFileTypes=options.listOfFileTypes||[],listOfOpenWithTypes=options.listOfOpenWithTypes||[];let imageLoaderSrc="https://cdn.jsdelivr.net/gh/cah12/fs-mongo/img/imageLoader.png",imageFolderSrc="https://cdn.jsdelivr.net/gh/cah12/fs-mongo/img/folder.png",imageFileSrc="https://cdn.jsdelivr.net/gh/cah12/fs-mongo/img/file.png";void 0!==options.imageLoaderSrc&&(imageLoaderSrc=options.imageLoaderSrc.length?options.imageLoaderSrc:null),void 0!==options.imageFolderSrc&&(imageFolderSrc=options.imageFolderSrc.length?options.imageFolderSrc:null),void 0!==options.imageFileSrc&&(imageFileSrc=options.imageFileSrc.length?options.imageFileSrc:null),options.fsServerUrl=options.fsServerUrl||"",options.sameDomain=void 0===options.sameDomain||options.sameDomain,options.persistSession=void 0===options.persistSession||options.persistSession;let editors=[];const chooseEditor=new ChooseEditor;function getEditorByName(editorName){const element=editors.find(element=>element.name===editorName);return void 0!==element?element.editor:null}function getEditorByExt(ext){for(let i=0;i<editors.length;++i){const editor=editors[i].editor,exts=editor.getExtensions();for(let n=0;n<exts.length;++n)if(exts[n]==ext)return editor}return null}this.registerEditor=function(editor){editors.push(editor)};let mongoFsLoginLogoutRegisterMenu=[{name:"Register",title:"Register for Mongo File System",fun:doRegister},{name:"Login",title:"Login to Mongo File System",fun:doLogin}];function doLogout(){self.disconnectFs(data=>{if(data.error)return console.log(data.msg);mongoFsLoginLogoutRegisterSeletor.contextMenu(mongoFsLoginLogoutRegisterMenu,{zIndex:2e3}),console.log(data.msg)})}function doNotepadDlg(){self.notepad&&self.notepad.openEditor()}this.doExplorerDlg=async function(){if(await init()){if(!inMemoryToken)return alert("Not connected...");$("#dlgTitle").html("File Explorer"),$("#inputFields").hide(),$("#dlgSaveButton").hide(),$("#explorerSaveAsModal").modal(),$("#saveAsType").val(".all")}},this.doSaveDlg=async function(){if(await init()){if(!inMemoryToken)return alert("Not connected...");$("#dlgTitle").html("Save As"),$("#inputFields").show(),$("#dlgSaveButton").show(),$("#explorerSaveAsModal").modal()}},$("body").keydown((function(e){!e.ctrlKey||"O"!==e.key&&"o"!==e.key||(e.preventDefault(),self.doExplorerDlg())}));let mongoFsLoginLogoutRegisterMenu2=[{name:"Logout",title:"Logout for Mongo File System",fun:doLogout},{name:"Explorer",title:"Launch the Mongo File System explorer.",fun:self.doExplorerDlg}];this.addMongoFsMenuItems=function(menuItems){for(let i=0;i<menuItems.length;++i)mongoFsLoginLogoutRegisterMenu2.push(menuItems[i])},this.addNotepadMenuItem=function(){mongoFsLoginLogoutRegisterMenu2.push({name:"Notepad",title:"Launch the Mongo File System notepad.",fun:doNotepadDlg})},this.addSaveMenuItem=function(editor){mongoFsLoginLogoutRegisterMenu2.push({name:"Save",title:"Saves current document to Mongo File System.",fun:editor.save}),$("body").keydown((function(e){!e.ctrlKey||"S"!==e.key&&"s"!==e.key||(e.preventDefault(),editor.save())}))},this.addSaveAsMenuItem=function(editor){mongoFsLoginLogoutRegisterMenu2.push({name:"Save As",title:"Saves current document to Mongo File System.",fun:editor.saveAs})};var loginDlg=$('<div id="registerLoginModal" class="modal fade" role="dialog"> <div class="modal-dialog"> \x3c!-- Modal content--\x3e <div class="modal-content"> <div class="modal-header"> <button type="button" class="close" data-dismiss="modal">&times;</button> <h4 style="color:rgb(51, 122, 183);" id="dlg-title" class="modal-title">Sign Up</h4> </div> <div class="modal-body"> <form id="registerLoginForm"> <div class="bottom-border"><span class="glyphicon glyphicon-user"></span><input id="dlg-username" name="username" class="no-outline" type="text" style="width: 97%; border-style: none;" placeholder="Enter Username"></div> <br> <div id="dlg-email-row"> <div class="bottom-border"><span class="glyphicon glyphicon-envelope"></span><input id="dlg-email" name="email" class="no-outline" type="email" style="width: 97%; border-style: none;" placeholder="Enter Email Address"></div> <br> </div> <div class="bottom-border"><span class="glyphicon glyphicon-lock"></span><input id="dlg-password"  name="password" class="no-outline" type="password" style="width: 97%; border-style: none;" placeholder="Enter Password"></div> <br> <div id="dlg-repeat-row"> <div class="bottom-border"><span class="glyphicon glyphicon-lock"></span><input id="dlg-repeat-password"  name="repeat_password" class="no-outline" type="password" style="width: 97%; border-style: none;" placeholder="Repeat Password"></div> </div> </form> </div> <div class="modal-footer"> <div><input type="button" id="dlg-cancel-button" class="btn btn-primary" value="Cancel" /> <input type="button" id="dlg-ok-button" class="btn btn-primary" value="Sig Up" /></div> </div> </div> </div> </div>');$("body").append(loginDlg);var saveDlg=$('<div id="explorerSaveAsModal" class="modal fade" role="dialog" data-backdrop="static" data-keyboard="false"> <div class="modal-dialog"> \x3c!-- Modal content--\x3e <div id="dlg-saveDlg" class="modal-content"> <div class="modal-header"><button id="saveDlgCancelX" type="button" class="close">&times;</button><h4 id="dlgTitle" class="modal-title">Save As</h4> </div> <div class="modal-body"><br> <div class="container"></div> <div class="row"> <div class="col-sm-1"></div> <div class="col-sm-10"> <div class="row"> <div class="col-sm-2"> <label for="parent">Folder</label> </div> <div class="col-sm-7"> <input type="text" class="form-control inputClass" id="parent1" readonly> </div> <div class="col-sm-3"> <input type="button" class="form-control inputClass" id="configButton" value="Config"> </div> </div> <br> <div class="row"> <div class="col-sm-5"> <div style="overflow: scroll; height: 200px; border: solid; border-width: 1px;"> <table style="border-width: 0px; white-space: nowrap;" id="foldersTable"> <tbody></tbody> </table> </div> </div> <div id="menuElement" style="position: relative;" class="col-sm-7"> <div style="overflow: scroll; height: 200px; border: solid; border-width: 1px;"> <table style="border-width: 0px; white-space: nowrap;" id="filesTable"> <tbody></tbody> </table> </div> </div> </div><br> <div id="inputFields"> <div class="row"> <div class="col-sm-3"> <label for="name">File name</label> </div> <div class="col-sm-9"> <input type="text" class="form-control inputClass" id="name" name="name" value="new"> </div> </div> <br> <div class="row"> <div class="col-sm-3"> <label for="saveAsType">Save as type</label> </div> <div class="col-sm-9"> <select class="form-control inputClass" id="saveAsType"></select> </div> </div> </div> <br><button id="dlgCancelButton" style="width: 20%" class="btn btn-primary pull-right">Cancel</button> <button id="dlgSaveButton" style="width: 79%" class="btn btn-primary">Save</button> </div> <div class="col-sm-1"></div> </div> </div> </div> </div> </div>');$("body").append(saveDlg);var configDlg=$('<div id="configModal" class="modal fade" role="dialog" data-backdrop="static" data-keyboard="false"> <div class="modal-dialog"> \x3c!-- Modal content--\x3e <div class="modal-content"> <div class="modal-header"><button id="configDlgCancelX" type="button" class="close">&times;</button><h4 id="dlg-title" style="text-align: center;" class="modal-title">Configuration</h4> </div> <div class="modal-body"><br> <div class="container"></div> <div class="row"> <div class="col-sm-1"></div> <div class="col-sm-10"> <div class="row"> <table class="config-table" style="width: 100%;"> <tr class="config-table"> <th class="config-table">Propery</th> <th class="config-table">Value</th> </tr> <tr class="config-table"> <td class="config-table">Root directory name</td> <td class="config-table"><input id="rootDir" type="text" style="width: 100%;" value="root:" /></td> </tr> <tr class="config-table"> <td class="config-table">Separator</td> <td class="config-table"><input id="sep" type="text" style="width: 100%;" value="" /></td> </tr> <tr class="config-table"> <td class="config-table">Dialog background color</td> <td class="config-table"><input id="dialog-background-color" type="color" value="#ffffff" /></td> </tr> <tr class="config-table"> <td class="config-table">Input background color</td> <td class="config-table"><input id="input-background-color" type="color" value="#ffffff" /></td> </tr> <tr class="config-table"> <td class="config-table">Store new files with GridFs</td> <td class="config-table"><input id="gridfs-storage" type="checkbox" checked /></td> </tr> </table> </div> <br> <div class="row"> <div class="col-sm-4"><input type="button" id="config-cancel-button" class="btn btn-primary" value="Cancel" style="width: 100%" ; /></div> <div class="col-sm-4"><input type="button" id="config-restore-button" class="btn btn-primary" value="Restore Defaults" style="width: 100%" ; /></div> <div class="col-sm-4"><input type="button" id="config-ok-button" class="btn btn-primary" value="Ok" style="width: 100%" ; /></div> </div> </div> </div> </div> </div> </div> </div>');saveDlg.append(configDlg),saveDlg.append($('<div id="chooseEditorModal" class="modal fade" role="dialog" data-backdrop="static" data-keyboard="false"> <div class="modal-dialog"> \x3c!-- Modal content--\x3e <div class="modal-content"> <div class="modal-header"><button id="chooseEditorCancelX" type="button" class="close">&times;</button> <h4 id="dlg-title" style="text-align: center;" class="modal-title">How would you like to open this file?</h4> </div> <div class="modal-body"><br> <div class="container"></div> <div class="row"> <div class="col-sm-1"></div> <div class="col-sm-10"> <div class="row"> <form id="chooseEditorTable" style="width: 100%;"> </form> </div> <br> <div class="row"> <label><input id="alwaysUse" type="checkbox"><span id="alwaysUseLabel"></span></label> </div> <br> <div class="row"> <div class="col-sm-6"><input type="button" id="chooseEditorCancel" class="btn btn-primary" value="Cancel" style="width: 100%" ; /></div> <div class="col-sm-6"><input type="button" id="chooseEditorOk" class="btn btn-primary" value="Ok" style="width: 100%" ; /></div> </div> </div> </div> </div> </div> </div> </div>')),imageLoaderSrc&&saveDlg.append($('<img id="imageLoader" class="loader" style= "position: absolute;" src='+imageLoaderSrc+">"));var configData=null;$("#chooseEditorCancel, #chooseEditorCancelX").click((function(){$("#chooseEditorModal").modal("hide")})),$("#config-restore-button").click(()=>{configData.dialogBackgroundColor="#ffffff",configData.inputBackgroundColor="#ffffff",configData.rootDir="root:",configData.sep="\\",configData.gridFsStorage=!0,$("#rootDir").val(configData.rootDir),$("#sep").val(configData.sep),$("#dialog-background-color").val(configData.dialogBackgroundColor),$("#input-background-color").val(configData.inputBackgroundColor),$("#gridfs-storage").prop("checked",configData.gridFsStorage)});var prevW=parseInt(saveDlg.css("width")),prevH=parseInt(saveDlg.css("height"));imageLoaderSrc&&($("#imageLoader").css("left",prevW/2-15),$("#imageLoader").css("top",prevH/2-15),$(window).on("resize",()=>{var w=parseInt(saveDlg.css("width"));w!==prevW&&$("#imageLoader").css("left",.5*w-15);var h=parseInt(saveDlg.css("height"));h!==prevH&&$("#imageLoader").css("top",.5*h-15)}),$("#imageLoader").hide());const m_fsServerUrl=fsServerUrl;var name="root",parentName="",currentRowSelector=null,currentSelectedRowSelector=null,nodes=null,filesTableRowSelected=!1,filesTableFileSelected=!1,selectedName=null,editing=!1,rigthClickOnSelectedRow=!1,fileExtensions=[];$("body").on("contextmenu",(function(e){e.preventDefault()})),$("#dlgCancelButton, #saveDlgCancelX").click((function(){$("#explorerSaveAsModal").attr("editorName",null),saveDlg.modal("hide")})),String.prototype.spliceStr=function(idx,rem,str){return this.slice(0,idx)+str+this.slice(idx+Math.abs(rem))};let timer=null;function stopCountDown(){clearTimeout(timer)}function refresh(cb){const refreshToken=self.getRefreshToken();(options.sameDomain||refreshToken)&&$.ajax({method:"POST",url:m_fsServerUrl+"/refresh_token",data:JSON.stringify({refreshToken:refreshToken}),contentType:"application/json; charset=utf-8",dataType:"json",success:function(data){inMemoryToken=data.accessToken,options.sameDomain||self.storeRefreshToken(data.refreshToken),clearTimeout(timer),countDown(),cb&&cb(!1,data)},error:function(data){self.clearRefreshToken(),cb&&cb(!0,data)}})}function countDown(){clearTimeout(timer),timer=setTimeout(()=>{refresh()},1e3*(options.accessTokenExpiry-.5))}function renameNode(){const currentName=currentSelectedRowSelector.attr("data-tt-displayName");var _data={};"file"===currentSelectedRowSelector.attr("data-tt-file")?_data.name=currentSelectedRowSelector.attr("data-tt-path"):_data.name=currentSelectedRowSelector.attr("data-tt-id");var input=$('<input type="text"/>');input.val(currentName);var td=$(currentSelectedRowSelector.children()[0]),innerTdHtml=td.html(),indexOfDisplayName=innerTdHtml.length-currentName.length;const n=innerTdHtml.indexOf(currentName);td.html(innerTdHtml.spliceStr(indexOfDisplayName,currentName.length,"")),td.append(input),input[0].focus(),currentSelectedRowSelector.toggleClass("selected"),editing=!0,input.on("keyup",(function(e){"Enter"!==e.key&&13!==e.keyCode||(input.remove(),editing=!1,td.html(innerTdHtml.spliceStr(indexOfDisplayName,$(this).val().length,$(this).val())))}));var changed=!1;input.focusout((async function(){changed||input.trigger("change")}));var m=1;input.change((async function(){if(_data.name==_data.newName)return input.remove(),editing=!1,void td.html(innerTdHtml.spliceStr(indexOfDisplayName,currentName.length,currentName));changed=!0;var g_data={},_parent=currentSelectedRowSelector.attr("data-tt-parent-id");g_data.name=_parent,g_data.name+=configData.sep,g_data.name+=$(this).val(),currentSelectedRowSelector.attr("data-tt-ext")&&(g_data.name+="."+currentSelectedRowSelector.attr("data-tt-ext"));try{$.ajax({method:"POST",headers:{Authorization:"Bearer "+inMemoryToken},url:m_fsServerUrl+"/access",data:JSON.stringify(g_data),contentType:"application/json; charset=utf-8",dataType:"json",success:function(res){!async function(){var parts,modifiedName=input.val().split("(")[0]+"("+m+")",ans;confirm(`The file "${input.val()}" already exist. Would you like to rename it to ${modifiedName}`)?(input.val(modifiedName),m++):(_data.newName=_data.name,editing=!1),changed=!1,input[0].focus()}()},error:function(res){_data.newName=g_data.name,$.ajax({method:"POST",headers:{Authorization:"Bearer "+inMemoryToken},url:m_fsServerUrl+"/rename",data:JSON.stringify(_data),contentType:"application/json; charset=utf-8",dataType:"json",success:function(data){!async function(){input.remove(),editing=!1,changed=!1,selectedName=_data.newName;try{await doInit(_parent)}catch(err){console.log("doInit failed 12"),alert("Initialisation failed. Please retry.")}}()},error:function(returnval){input[0].focus(),input.trigger("change")}})}})}catch(err){console.log(50,err)}}))}function doDelete(){var message="";if(message="file"==currentSelectedRowSelector.attr("data-tt-file")?`Do you want to permanently remove the file "${currentSelectedRowSelector.attr("data-tt-path")}"?`:`Do you want to permanently remove the folder "${selectedName}"?`,confirm(message)){var node=$("#filesTable").treetable("node",currentSelectedRowSelector.attr("id")),_parent=currentSelectedRowSelector.attr("data-tt-parent-id"),endPoint="removeFolder",m_selectedName=selectedName;if("file"!=currentSelectedRowSelector.attr("data-tt-file")||(endPoint="removeFile",m_selectedName=m_selectedName.replace("f",""),currentFilename!==m_selectedName)){var _data={name:m_selectedName};$.ajax({method:"DELETE",url:m_fsServerUrl+"/"+endPoint,headers:{Authorization:"Bearer "+inMemoryToken},data:JSON.stringify(_data),contentType:"application/json; charset=utf-8",dataType:"json",success:function(){!async function(){try{await doInit(_parent),selectedName=null}catch{console.log("doInit failed 1"),alert("Initialisation failed. Please retry.")}}()},error:function(returnval){console.log(returnval.responseJSON),alert(`Failed to delete "${m_selectedName}". Please retry.`),currentSelectedRowSelector.toggleClass("selected")}})}else alert(`The file "${currentFilename}" is opened. Close it before deleting it.`)}}function addFile(){var _parent=$("#parent1").val(),_data={id:"inputRowId",isFile:!0,displayName:"",parentId:_parent,parentPath:_parent},node=null;currentSelectedRowSelector&&(node=$("#filesTable").treetable("node",currentSelectedRowSelector.attr("id")));var input=$('<input type="text"/>');input.val($("#name").val());var inputRow=makeRow(_data),td;$("#filesTable").treetable("loadBranch",node,inputRow),editing=!0,$(inputRow.children()[0]).append(input),input[0].focus();var _ext=$("#saveAsType").val(),error=!1,changed=!1;input.focusout((async function(){changed||input.trigger("change")}));var n=1;input.change((async function(){if(changed=!0,""==$(this).val().trim())try{$("#filesTable").treetable("removeNode",inputRow.attr("id"))}catch(err){}else{var m_data={};if(m_data.name=_parent+configData.sep+$(this).val(),".all"!==_ext){var ext=getFileExtension($(this).val());ext&&_ext===ext||(m_data.name+=_ext)}try{$.ajax({method:"POST",url:m_fsServerUrl+"/access",headers:{Authorization:"Bearer "+inMemoryToken},data:JSON.stringify(m_data),contentType:"application/json; charset=utf-8",dataType:"json",success:function(res){!async function(){var parts,modifiedName=input.val().split("(")[0]+"("+n+")",ans;confirm(`The file "${input.val()}" already exist. Would you like to rename it to ${modifiedName}`)?(input.val(modifiedName),n++):(input.val(""),editing=!1),changed=!1,input[0].focus()}()}})}catch(err){console.log(50,err)}$.ajax({method:"POST",url:m_fsServerUrl+"/createFile",headers:{Authorization:"Bearer "+inMemoryToken},data:JSON.stringify(m_data),contentType:"application/json; charset=utf-8",dataType:"json",success:function(data){!async function(){try{await doInit(_parent),editing=!1}catch{console.log("doInit failed 2"),alert("Initialisation failed. Please retry.")}}()},error:function(returnval){var parts,modifiedName=input.val().split("(")[0]+"("+n+")",ans;confirm(`The file "${input.val()}" already exist. Would you like to rename it to ${modifiedName}`)?(input.val(modifiedName),n++):(input.val(""),editing=!1),changed=!1,input[0].focus()}})}}))}var addingFolder=!1;function addFolder(_data){var _parent=$("#parent1").val(),_data={id:"inputRowId",isFile:!1,displayName:"",parentId:_parent,parentPath:_parent};addingFolder=!0;var node=null;currentSelectedRowSelector&&(node=$("#filesTable").treetable("node",currentSelectedRowSelector.attr("id")));var input=$('<input type="text"/>'),inputRow=makeRow(_data),td;$("#filesTable").treetable("loadBranch",node,inputRow),$(inputRow.children()[0]).append(input),input[0].focus(),input.focusout((function(){addingFolder=!1;var str=$(this).val().trim();if(""==$(this).val().trim())try{$("#filesTable").treetable("removeNode",inputRow.attr("id"))}catch{}})),input.change((function(){addingFolder=!1;var m_data={};m_data.name=_parent+configData.sep+$(this).val(),""!==$(this).val().trim()&&$.ajax({method:"POST",url:m_fsServerUrl+"/createFolder",headers:{Authorization:"Bearer "+inMemoryToken},data:JSON.stringify(m_data),contentType:"application/json; charset=utf-8",dataType:"json",success:function(data){!async function(){try{await doInit(_parent)}catch{console.log("doInit failed 3"),alert("Initialisation failed. Please retry.")}}()},error:function(returnval){alert(returnval.responseJSON.msg),input[0].focus()}})}))}let openFileWithSubmenu=[];openFileWithSubmenu.push({name:"Choose...",title:"Launches the choose dialog",fun:function(){!async function(){const filename=selectedName.replace("f","");let ext=selectedName.slice(selectedName.length-4);"."!==ext.charAt(0)&&(ext=".all");try{const editor=await chooseEditor.chooseEditorByExt(editors,ext);openFile(filename,{editorName:editor.m_data.name})}catch(err){console.log(err)}}()}});var menuNotSelectedSubmenu=[{name:"Folder",title:"Creates a new folder.",fun:function(){addingFolder||currentSelectedRowSelector&&"file"==currentSelectedRowSelector.attr("data-tt-file")||addFolder()}},{name:"Text Document",title:"Creates a new text document.",fun:function(){$("#name").val("New Text Document"),$("#saveAsType").val(".txt"),updateFilesTable(),currentSelectedRowSelector&&"file"==currentSelectedRowSelector.attr("data-tt-file")||addFile()}}];listOfFileTypes.forEach(item=>{var menuItem={name:item.defaultFilename,title:`Creates a new ${item.defaultFilename}.`,fun:function(){$("#name").val(`New ${item.defaultFilename}`),$("#saveAsType").val(item.ext),currentSelectedRowSelector&&"file"==currentSelectedRowSelector.attr("data-tt-file")||addFile()}};menuNotSelectedSubmenu.push(menuItem)}),listOfOpenWithTypes.forEach(item=>{var menuItem={name:item.name,title:`Opens with ${item.name}.`,fun:function(){openFileWith({editorName:item.name,options:item.options})}};openFileWithSubmenu.push(menuItem)});var menuNotSelected=[{name:"New",title:"Creates a new folder or file",subMenu:menuNotSelectedSubmenu}],openFileWithMenu={name:"Open with...",title:"Opens the current selection",subMenu:openFileWithSubmenu};let nodeToCopy=null,nodeCut=!1;function copyNode(){nodeToCopy=selectedName,"file"==currentSelectedRowSelector.attr("data-tt-file")&&(nodeToCopy=nodeToCopy.replace("f",""))}function cutNode(){nodeToCopy=selectedName,"file"==currentSelectedRowSelector.attr("data-tt-file")&&(nodeToCopy=nodeToCopy.replace("f","")),nodeCut=!0}function pasteNode(cb){let dest=selectedName||$("#parent1").val();const src=nodeToCopy;`f${src}`===dest&&(dest=$("#rootDir").val());const arr=nodeToCopy.split(configData.sep),name=dest+configData.sep+arr[arr.length-1];let m_data={src:src,dest:dest};$.ajax({method:"POST",headers:{Authorization:"Bearer "+inMemoryToken},url:m_fsServerUrl+"/access",data:JSON.stringify({name:name}),contentType:"application/json; charset=utf-8",dataType:"json",success:function(res){!async function(){confirm(`File with the name "${name}" already exist. Do you want to replace it?`)&&$.ajax({method:"POST",url:m_fsServerUrl+"/copyFile",headers:{Authorization:"Bearer "+inMemoryToken},data:JSON.stringify(m_data),contentType:"application/json; charset=utf-8",dataType:"json",success:function(cpyName){nodeToCopy=null,cb&&cb(src)},error:function(err){console.log(err.responseJSON),cb&&cb(null)}})}()},error:function(res){$.ajax({method:"POST",url:m_fsServerUrl+"/copyFile",headers:{Authorization:"Bearer "+inMemoryToken},data:JSON.stringify(m_data),contentType:"application/json; charset=utf-8",dataType:"json",success:function(cpyName){nodeToCopy=null,cb&&cb(src)},error:function(err){console.log(err.responseJSON),cb&&cb(null)}})}})}var pasteMenu={name:"Paste",title:"Paste the current selection",fun:function(){pasteNode(async cpy=>{if(nodeCut)$.ajax({method:"DELETE",url:m_fsServerUrl+"/removeFile",headers:{Authorization:"Bearer "+inMemoryToken},data:JSON.stringify({name:cpy}),contentType:"application/json; charset=utf-8",dataType:"json",success:function(){!async function(){try{await doInit($("#parent1").val()),nodeCut=!1}catch{console.log("doInit failed 5"),alert("Initialisation failed. Please retry.")}}()},error:function(returnval){console.log(returnval.responseJSON),alert(returnval.responseJSON)}});else try{await doInit($("#parent1").val())}catch{console.log("doInit failed 6")}})}},menuSelected=[{name:"Open",title:"Opens the current selection.",fun:function(){currentSelectedRowSelector.trigger("dblclick")}},{name:"Rename",title:"Renames the current selection.",fun:function(){renameNode()}},{name:"Cut",title:"Cuts the current selection.",fun:function(){cutNode()}},{name:"Copy",title:"Copies the current selection.",fun:function(){copyNode()}},{name:"Delete",title:"Deletes current selection.",fun:function(){doDelete()}}],pointIn=!1;$("#menuElement").mouseenter(()=>{pointIn=!0}),$("#menuElement").mouseleave(()=>{pointIn=!1});var menuActive=!1;$("#explorerSaveAsModal").mousedown((function(e){if(2==e.button&&pointIn){currentSelectedRowSelector&&!rigthClickOnSelectedRow&&(currentSelectedRowSelector.toggleClass("selected"),currentSelectedRowSelector=null,filesTableRowSelected=!1,filesTableFileSelected=!1),menuActive=!0,currentSelectedRowSelector&&("file"==currentSelectedRowSelector.attr("data-tt-file")?(openFileWithSubmenu.length>0&&"Open with..."!==menuSelected[1].name&&menuSelected.splice(1,0,openFileWithMenu),"Paste"===menuSelected[0].name&&menuSelected.splice(0,1)):(openFileWithSubmenu.length>0&&"Open with..."===menuSelected[1].name&&menuSelected.splice(1,1),nodeToCopy?"Paste"!==menuSelected[0].name&&menuSelected.splice(0,0,pasteMenu):"Paste"===menuSelected[0].name&&menuSelected.splice(0,1))),nodeToCopy?"Paste"!==menuNotSelected[0].name&&menuNotSelected.splice(0,0,pasteMenu):"Paste"===menuNotSelected[0].name&&menuNotSelected.splice(0,1);var menu=1==filesTableRowSelected?menuSelected:menuNotSelected;$("#explorerSaveAsModal").contextMenu(menu,{triggerOn:"contextmenu touchstart"}),rigthClickOnSelectedRow=!1}else menuActive&&($("#explorerSaveAsModal").contextMenu("destroy"),menuActive=!1)})),$("#saveAsType").append($('<option value=".all">All Files</option>')),fileExtensions.push(".all"),$("#saveAsType").append($('<option value=".txt">Text documents (*.txt)</option>')),fileExtensions.push(".txt");for(var i=0;i<listOfFileTypes.length;++i)$("#saveAsType").append($("<option value="+listOfFileTypes[i].ext+">"+listOfFileTypes[i].display+"</option>")),fileExtensions.push(listOfFileTypes[i].ext);function getChildren(nodeName){for(var result=[],i=0;i<nodes.length;++i)nodes[i].path.length>nodeName.length&&-1!==nodes[i].path.indexOf(nodeName)&&nodes[i].parentPath==nodeName&&result.push(nodes[i]);return result}function selectRow(row){"string"==typeof row&&(row=$(document.getElementById(row))),currentRowSelector&&currentRowSelector.hasClass("selected")&&currentRowSelector.toggleClass("selected"),row&&row.toggleClass("selected");var idAttr=null;if(row&&row.hasClass("selected")&&(filesTableRowSelected=!1,idAttr=row.attr("data-tt-id"),row.attr("data-tt-parent-id")))for(var nodeIds=row.attr("data-tt-parent-id").split(configData.sep),id="",i=0;i<nodeIds.length;++i)i>0&&(id+=configData.sep),id+=nodeIds[i],$("#foldersTable").treetable("expandNode",id);return!!idAttr&&(currentRowSelector=row,name=idAttr,parentName=row.attr("data-tt-parent-id"),!0)}function clearFilesTable(){for(var chdrn=$($("#filesTable").children()[0]).children(),i=0;i<chdrn.length;++i)$(chdrn[i]).remove()}function getFileExtension(name){var l=name.length,str=name[l-4];return"."!==str?null:(str+=name[l-3],str+=name[l-2],".all"==(str+=name[l-1])?null:str)}function updateFilesTable(){clearFilesTable();for(var children=getChildren(name),i=0;i<children.length;++i){var _name=children[i].path;if(children[i].isFile){var selectedExtType=$("#saveAsType").val();if(".all"==selectedExtType){addRow(children[i]);continue}if(children[i].ext){const dotExt="."+children[i].ext;dotExt==selectedExtType&&addRow(children[i]);continue}}else addRow(children[i])}}function drag(ev){ev.originalEvent.dataTransfer.setData("text",$(this).attr("id"))}function allowDrop(ev){ev.preventDefault()}function drop(ev){ev.preventDefault();var originalNode=$(document.getElementById(ev.originalEvent.dataTransfer.getData("text"))),finalNode=$(document.getElementById($(this).attr("id")));if("file"!==finalNode.attr("data-tt-file")){var originalPath=originalNode.attr("data-tt-path")||originalNode.attr("id"),finalPath=finalNode.attr("data-tt-id");if(-1!==finalPath.indexOf(originalPath))return void console.log(789);var parts=originalPath.split(configData.sep),originalBasename=parts[parts.length-1],newName=finalPath+configData.sep+originalBasename;if(originalPath==newName)return;let m_data={name:originalPath,newName:newName};$.ajax({method:"POST",url:m_fsServerUrl+"/rename",headers:{Authorization:"Bearer "+inMemoryToken},data:JSON.stringify(m_data),contentType:"application/json; charset=utf-8",dataType:"json",success:function(data){!async function(){if("file"===originalNode.attr("data-tt-file"))try{await doInit(finalPath)}catch{console.log("doInit failed 7"),alert("Initialisation failed. Please retry.")}else try{await doInit(newName)}catch{console.log("doInit failed 8"),alert("Initialisation failed. Please retry.")}}()},error:function(err){"File with that name already exist"===err.responseJSON.msg&&confirm(`File with the name "${newName}" already exist. Do you want to replace it?`)&&(m_data.replaceFile=!0,$.ajax({method:"POST",url:m_fsServerUrl+"/rename",headers:{Authorization:"Bearer "+inMemoryToken},data:JSON.stringify(m_data),contentType:"application/json; charset=utf-8",dataType:"json",success:function(data){!async function(){if("file"===originalNode.attr("data-tt-file"))try{await doInit(finalPath)}catch{console.log("doInit failed 9"),alert("Initialisation failed. Please retry.")}else try{await doInit(newName)}catch{console.log("doInit failed 10"),alert("Initialisation failed. Please retry.")}}()},error:function(err){console.log(err.responseJSON)}}))}})}}function makeRow(rootData){var row=null;rootData.isFile?((row=imageFileSrc?$('<tr draggable="true"><td style="border-width: 0px;"><img src='+imageFileSrc+"> "+rootData.displayName+"</td></tr>"):$('<tr draggable="true"><td style="border-width: 0px;">'+rootData.displayName+"</td></tr>")).attr("data-tt-file","file"),row.attr("data-tt-ext",rootData.ext),row.attr("data-tt-path",rootData.path)):(row=imageFolderSrc?$('<tr><td style="border-width: 0px;"><img src='+imageFolderSrc+"> "+rootData.displayName+"</td></tr>"):$('<tr><td style="border-width: 0px;">'+rootData.displayName+"</td></tr>")).attr("data-tt-file","folder"),row.attr("data-tt-displayName",rootData.displayName);var _id=rootData.id;return row.attr("data-tt-id",_id),row.attr("id",_id),void 0!==rootData.parentPath&&""!==rootData.parentPath&&row.attr("data-tt-parent-id",rootData.parentId),rootData.path==configData.rootDir&&(currentRowSelector=row),row.on("dragstart",drag),row.on("dragover",allowDrop),row.on("drop",drop),row}function addRow(rootData){$($("#filesTable").children()[0]).append(makeRow(rootData))}$("#saveAsType").on("change",()=>{updateFilesTable()}),$("#foldersTable tbody").on("mousedown","tr",(function(e){0==e.button&&($(".selected").not(this).removeClass("selected"),selectRow($(this)),$("#parent1").val(name),$(this).hasClass("selected")&&"file"!==$(this).attr("data-tt-file")&&updateFilesTable())})),$("#filesTable tbody").on("mousedown","tr",(function(e){if(2!=e.button){if(0==e.button&&!editing){if(selectedName=null,$(".selected").not(this).removeClass("selected"),$(this).toggleClass("selected"),$(this).hasClass("selected")){if(filesTableRowSelected=!0,selectedName=$(this).attr("id"),"file"==$(this).attr("data-tt-file")){filesTableFileSelected=!0,$("#name").val($(this).attr("data-tt-displayName"));var ext=getFileExtension(selectedName)||".all";$("#saveAsType").val(ext)}else filesTableFileSelected=!1;currentSelectedRowSelector=$(this)}else filesTableRowSelected=!1,currentSelectedRowSelector=null,rigthClickOnSelectedRow=!1;var _parent=$(this).attr("data-tt-parent-id")}}else currentSelectedRowSelector?currentSelectedRowSelector.attr("id")!==$(this).attr("id")?(currentSelectedRowSelector.toggleClass("selected"),currentSelectedRowSelector=null,filesTableRowSelected=!1,filesTableFileSelected=!1,rigthClickOnSelectedRow=!1):rigthClickOnSelectedRow=!0:rigthClickOnSelectedRow=!1})),$("#filesTable tbody").on("dblclick","tr",(function(){var _name=$(this).attr("id");"file"!==$(this).attr("data-tt-file")?(selectRow(_name),$("#parent1").val(_name),updateFilesTable()):editing||openFile($(this).attr("data-tt-path"),{editorName:$("#explorerSaveAsModal").attr("editorName")})}));var optns={expandable:!0,clickableNodeNames:!0};$("#filesTable").treetable(optns);var initialized=!1;function openFile(filename,{editorName:editorName,options:options}){$(window).trigger("beforeOpen",[filename,getFileExtension(filename),editorName||null]);var _data={name:filename,options:options=options||{encoding:"utf8",flag:"r"}};$.ajax({method:"POST",url:m_fsServerUrl+"/readStream",headers:{Authorization:"Bearer "+inMemoryToken},data:JSON.stringify(_data),contentType:"application/json; charset=utf-8",beforeSend:function(){imageLoaderSrc&&$("#imageLoader").show()},complete:function(){imageLoaderSrc&&$("#imageLoader").hide()},success:function(data){!async function(){let editor=null;editor=void 0!==editorName?getEditorByName(editorName):await chooseEditor.getEditorByExt(editors,getFileExtension(filename)),$(window).trigger("fileOpened",[data,filename,getFileExtension(filename),editor.m_data.name]),editor?editor.setData(data,filename,getFileExtension(filename),editorName):self.setData&&self.setData(data,filename,getFileExtension(filename)),currentFilename=filename,"File Explorer"===$("#dlgTitle").html()&&$("#saveAsType").val(".all")}()},error:function(returnval){if(!self.getRefreshToken())return doLogout(),alert("Please login."),void location.reload();console.log(returnval.responseJSON),alert("Unexpected error. Please retry.")}})}function openFileWith(obj){openFile(currentSelectedRowSelector.attr("data-tt-path"),obj)}function doConfigDlg(){getConfigFs(data=>{$("#rootDir").val(data.rootDir||"root:"),$("#sep").val(data.sep||"\\"),$("#dialog-background-color").val(data.dialogBackgroundColor||"#ffffff"),$("#input-background-color").val(data.inputBackgroundColor||"#ffffff"),$("#gridfs-storage").prop("checked",data.gridFsStorage),$("#configModal").modal()})}function doLogin(){$("#dlg-repeat-row").hide(),$("#dlg-email-row").hide(),$("#dlg-title").html("Sign In"),$("#dlg-ok-button").val("Sign In"),$("#dlg-password").val(""),$("#registerLoginModal").modal()}function doRegister(){$("#dlg-repeat-row").show(),$("#dlg-email-row").show(),$("#dlg-title").html("Sign Up"),$("#dlg-ok-button").val("Sign Up"),$("#dlg-password").val(""),$("#dlg-repeat-password").val(""),$("#registerLoginModal").modal()}function validateEmail(email){const re=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;return re.test(email)}$("#dlgSaveButton").click(async()=>{try{const ext=".all"==$("#saveAsType").val()?null:$("#saveAsType").val();let data=null;const editor=getEditorByName($("#explorerSaveAsModal").attr("editorName"));data=editor?editor.getData(ext):self.getData(ext),await self.saveAs(data),$("#explorerSaveAsModal").modal("hide")}catch{$("#name")[0].focus()}}),$(".config-close").click(()=>{$("#configModal").modal("hide")}),$("#config-cancel-button, #configDlgCancelX").click(()=>{$("#configModal").modal("hide")}),$("#config-ok-button").click(async()=>{configData.gridFsStorage=$("#gridfs-storage").prop("checked"),configData.rootDir=$("#rootDir").val(),configData.sep=$("#sep").val(),configData.dialogBackgroundColor=$("#dialog-background-color").val(),configData.inputBackgroundColor=$("#input-background-color").val(),setConfigFs(configData,async err=>{try{try{await doInit(configData.rootDir)}catch{console.log("doInit failed 11"),alert("Initialisation failed. Please retry.")}}catch(err){console.log("Init failed"),alert("Initialisation failed. Please retry.")}err||$("#configModal").modal("hide")})}),$("#dlg-ok-button").on("click",()=>{if("Sign In"==$("#dlg-title").html())self.connectFs($("#registerLoginForm").serializeJSON(),data=>{if(data.error)return alert(data.msg),void("Not registered."===data.msg&&doRegister());$("#dlg-password").val(""),mongoFsLoginLogoutRegisterSeletor&&mongoFsLoginLogoutRegisterSeletor.contextMenu(mongoFsLoginLogoutRegisterMenu2,{zIndex:2e3}),console.log(data.msg),$("#registerLoginModal").modal("hide")});else{if(!validateEmail($("#dlg-email").val()))return void alert("Invalid email");if($("#dlg-password").val()!==$("#dlg-repeat-password").val())return void alert("Password different from repeat-password");self.registerFs($("#registerLoginForm").serializeJSON(),data=>{data.success?($("#dlg-password").val(""),$("#dlg-repeat-password").val(""),$(window).trigger("registered",$("#dlg-username").val()),$("#registerLoginModal").modal("hide")):(alert(data.msg),$("#dlg-username").val(""),$("#dlg-email").val(""),$("#dlg-password").val(""),$("#dlg-repeat-password").val(""))})}}),$("#dlg-password").keyup((function(e){"Sign In"==$("#dlg-title").html()&&13===e.keyCode&&$("#dlg-ok-button").trigger("click")})),$("#dlg-repeat-password").keyup((function(e){13===e.keyCode&&$("#dlg-ok-button").trigger("click")})),$("#configButton").click(()=>{doConfigDlg()}),$("#dlg-cancel-button").on("click",()=>{$("#registerLoginModal").modal("hide")});let mongoFsLoginLogoutRegisterSeletor=$(".mongo-fs-login-logout-register");if(mongoFsLoginLogoutRegisterSeletor[0]||(mongoFsLoginLogoutRegisterSeletor=null),mongoFsLoginLogoutRegisterSeletor){const glyphiconUser=$('<span class="glyphicon glyphicon-user"></span>');mongoFsLoginLogoutRegisterSeletor.html("Mongo File System(MFS)"),mongoFsLoginLogoutRegisterSeletor.append(glyphiconUser),mongoFsLoginLogoutRegisterSeletor.attr("title","Register for or Login to Mongo File System"),mongoFsLoginLogoutRegisterSeletor.contextMenu(mongoFsLoginLogoutRegisterMenu,{zIndex:2e3})}this.saveAs=function(fileData,_flag){return new Promise((resolve,reject)=>{const flag=_flag||"wx";var _data={};_data.options={encoding:"utf8",mode:438,flag:flag},_data.name=$("#parent1").val()+configData.sep+$("#name").val(),_data.data=fileData;const ext=$("#saveAsType").val();".all"!==ext&&(_data.name+=ext),currentFilename=_data.name,$(window).trigger("beforeEditorSaveAs",[_data.name]),$.ajax({method:"POST",url:m_fsServerUrl+"/createFile",headers:{Authorization:"Bearer "+inMemoryToken},data:JSON.stringify(_data),contentType:"application/json; charset=utf-8",dataType:"json",beforeSend:function(){imageLoaderSrc&&$("#imageLoader").show()},complete:function(){imageLoaderSrc&&$("#imageLoader").hide()},success:function(data){$(window).trigger("afterSave"),$(window).trigger("fileSaved",[_data.name,$("#explorerSaveAsModal").attr("editorName")]),$(window).trigger("afterEditorSaveAs",[_data.name,$("#explorerSaveAsModal").attr("editorName")]),resolve(!0)},error:async function(err){if(confirm(`A file with the name "${_data.name}" already exist. Would you like to replace it ?`))try{await self.saveAs(fileData,"w"),$(window).trigger("fileSaved",[_data.name,$("#explorerSaveAsModal").attr("editorName")]),$(window).trigger("afterEditorSaveAs",[_data.name,$("#explorerSaveAsModal").attr("editorName")]),resolve(!0)}catch(err){$(window).trigger("afterEditorSaveAs",[_data.name,$("#explorerSaveAsModal").attr("editorName")]),reject(!1)}else $(window).trigger("afterEditorSaveAs",[_data.name,$("#explorerSaveAsModal").attr("editorName")]),reject(!1)}})})},this.save=function(filename,fileData){return new Promise((resolve,reject)=>{$(window).trigger("beforeSave",filename);var _data={options:{encoding:"utf8",mode:438,flag:"w"}};_data.name=filename,_data.data=fileData;const ext=getFileExtension(filename);ext||(_data.name+=".all"),$.ajax({method:"POST",url:m_fsServerUrl+"/writeFile",headers:{Authorization:"Bearer "+inMemoryToken},data:JSON.stringify(_data),contentType:"application/json; charset=utf-8",dataType:"json",beforeSend:function(){imageLoaderSrc&&$("#imageLoader").show()},complete:function(){imageLoaderSrc&&$("#imageLoader").hide()},success:function(data){$(window).trigger("afterSave"),$(window).trigger("fileSaved",[filename,$("#explorerSaveAsModal").attr("editorName")]),resolve(!0)},error:function(err){reject(!1)}})})},$("#foldersTable").treetable(options);let prevRoot=options.rootDir||"root:";function doInit(selectedFolder){return new Promise((resolve,reject)=>{$("#dlg-saveDlg").css("background-color",configData.dialogBackgroundColor||"#ffffff"),$(".inputClass").css("background-color",configData.inputBackgroundColor||"#ffffff"),$.ajax({method:"GET",headers:{Authorization:"Bearer "+inMemoryToken},url:m_fsServerUrl+"/tree",success:function(data){nodes=data.tree,initialized&&$("#foldersTable").treetable("removeNode",prevRoot),prevRoot=configData.rootDir;for(var i=0;i<data.tree.length;++i)if(!data.tree[i].isFile){var parentNode=$("#foldersTable").treetable("node",data.tree[i].parentId);$("#foldersTable").treetable("loadBranch",parentNode,makeRow(data.tree[i]))}initialized=!0,$("#foldersTable").treetable("collapseAll"),selectRow(selectedFolder),updateFilesTable();var m_name=selectedFolder;$("#parent1").val(m_name),resolve(!0)},error:function(returnval){reject(!1)}})})}async function init(){try{return await doInit(configData.rootDir),!0}catch(err){return console.log("doInit failed 13"),self.getRefreshToken()?(alert("Initialisation failed. Please retry."),!1):(doLogout(),alert("Please login."),location.reload(),!1)}}function getConfigFs(cb){$.ajax({method:"GET",url:m_fsServerUrl+"/config",headers:{Authorization:"Bearer "+inMemoryToken},contentType:"application/json; charset=utf-8",dataType:"json",success:function(data){cb(data)},error:function(data){cb(data)}})}function setConfigFs(data,cb){$.ajax({method:"POST",url:m_fsServerUrl+"/config",headers:{Authorization:"Bearer "+inMemoryToken},data:JSON.stringify(data),contentType:"application/json; charset=utf-8",dataType:"json",success:function(){cb(null)},error:function(data){cb(data.responseJSON)}})}function breakdown(){$.ajax({method:"DELETE",url:m_fsServerUrl+"/breakdown",contentType:"application/json; charset=utf-8",dataType:"json",success:function(data){},error:function(data){console.log(data)}})}function refreshSession(){options.persistSession?refresh((err,data)=>{err?console.log(data.responseJSON.msg):$.ajax({method:"POST",url:m_fsServerUrl+"/re-connect",headers:{Authorization:"Bearer "+inMemoryToken},contentType:"application/json; charset=utf-8",dataType:"json",success:function(data){mongoFsLoginLogoutRegisterSeletor&&mongoFsLoginLogoutRegisterSeletor.contextMenu(mongoFsLoginLogoutRegisterMenu2,{zIndex:2e3}),configData=data.configData,name=configData.rootDir,$(window).trigger("connected",data.username)},error:function(data){console.log(data)}})}):self.clearRefreshToken()}function setup(){$.ajax({method:"POST",url:m_fsServerUrl+"/setup",data:JSON.stringify({sameDomain:options.sameDomain,accessTokenExpiry:options.accessTokenExpiry}),contentType:"application/json; charset=utf-8",dataType:"json",success:function(data){refreshSession()},error:function(data){console.log(data)}})}this.registerFs=function(registerData,cb){"function"==typeof registerData&&(cb=registerData,registerData=void 0),$.ajax({method:"POST",url:m_fsServerUrl+"/registerFs",headers:{Authorization:"Bearer "+inMemoryToken},data:JSON.stringify(registerData),contentType:"application/json; charset=utf-8",dataType:"json",success:function(data){cb&&cb(data)},error:function(data){cb&&cb(data)}})},this.connectFs=function(connectData,cb){"function"==typeof connectData&&(cb=connectData,connectData=void 0),$.ajax({method:"POST",url:m_fsServerUrl+"/connect",data:JSON.stringify(connectData),contentType:"application/json; charset=utf-8",dataType:"json",success:function(data){inMemoryToken=data.accessToken,options.sameDomain||self.storeRefreshToken(data.refreshToken),clearTimeout(timer),countDown(),configData=data.configData,name=configData.rootDir,cb&&cb({error:!1,msg:"Connected"}),$(window).trigger("connected",data.username)},error:function(data){cb&&cb(data.responseJSON)}})},this.disconnectFs=function(cb){$(window).trigger("disconnected"),stopCountDown(),localStorage.setItem("logout",Date.now());const refreshToken=self.getRefreshToken();if(!refreshToken)return inMemoryToken=null,void(cb&&cb({error:!1,msg:"Disconnected: refresh token not found"}));$.ajax({method:"POST",url:m_fsServerUrl+"/disconnect",headers:{Authorization:"Bearer "+inMemoryToken},contentType:"application/json; charset=utf-8",data:JSON.stringify({refreshToken:refreshToken}),dataType:"json",success:function(data){inMemoryToken=null,self.clearRefreshToken(),cb&&cb({error:!1,msg:"Disconnected"})},error:function(data){cb&&cb({error:!0,msg:data.responseJSON})}})},this.isConnected=async function(){return null!==inMemoryToken},window.addEventListener("storage",event=>{"logout"===event.key&&console.log("logged out from storage!")}),window.onbeforeunload=function(e){for(let i=0;i<editors.length;++i)if(editors[i].editor.currentFileModified())return e.preventDefault(),e.returnValue="","";options.persistSession||self.disconnectFs(),breakdown()},window.addEventListener("load",event=>{self.clearRefreshToken()}),setup()}getRefreshToken(){return localStorage.getItem("RefreshToken")}storeRefreshToken(token){localStorage.setItem("RefreshToken",token)}clearRefreshToken(){localStorage.removeItem("RefreshToken")}enableNotepad(){const editorSelector=$('<div id="notepadModal" class="modal fade" role="dialog" data-backdrop="static" data-keyboard="false"> <div class="modal-dialog" role="document" style="width: 98%;"> <div class="modal-content"> <div class="modal-header"> <img src="https://cdn.jsdelivr.net/gh/cah12/fs-mongo/img/file.png"> <label class="modal-title" id="notepadModalLabel">Mongo Notepad</label> <button id="closeXButton100" type="button" class="close" aria-label="Close"> <span aria-hidden="true">&times;</span> </button> </div> <div class="modal-body" > <textarea id="myNotepad" autocomplete="false" spellcheck="false" style="outline: none; resize: none; width: 100%;"></textarea> </div> <div class="modal-footer"> <button id="closeButton" type="button" class="btn btn-secondary">Close</button> <button id="notepadOpenFile" type="button" class="btn btn-primary">Open file</button> <button id="notepadSaveAs" type="button" class="btn btn-primary">Save As</button> <button id="notepadSave" type="button" class="btn btn-primary" disabled>Save</button> </div> </div> </div> </div>');$("body").append(editorSelector),$("#myNotepad").css("height",.71*$(window).height());const options={};options.fs=this,options.editorName="Text Editor",options.fileExtensions=[".txt",null],options.explorerDialogParentId="notepadModal",options.idsOpen="notepadOpenFile",options.idsClose=["closeButton","closeXButton100"],options.idsSave="notepadSave",options.idsSaveAs="notepadSaveAs",options.idEditorLabel="notepadModalLabel",this.notepad=new MongoNotepad(options),this.registerEditor({name:"Text Editor",editor:this.notepad}),this.addNotepadMenuItem()}}class Editor{constructor(obj){const{fs:fs,editorName:editorName,fileExtensions:fileExtensions,explorerDialogParentId:explorerDialogParentId,idsOpen:idsOpen,idsClose:idsClose,idsSave:idsSave,idsSaveAs:idsSaveAs,idEditorLabel:idEditorLabel}=obj,self=this;self.m_data={},self.m_data.m_fs=fs,self.m_data.m_editor_opened=!1,self.m_data.currentFilename=null,self.m_data.currentFileModified=!1,self.m_data.currentFileSaving=!1,self.m_data.name=editorName,self.m_data.editorSelector=explorerDialogParentId?$(`#${explorerDialogParentId}`):$("body");const extensions=fileExtensions;let modifiedname=editorName.replaceAll(" ",""),classes={};function addClassToElements(ids,classType){let _ids=[];"string"==typeof ids?_ids.push(ids):_ids=ids;for(let i=0;i<_ids.length;++i)$(`#${_ids[i]}`).addClass(classes[classType])}async function doSave(){if(self.m_data.currentFilename)try{if(!self.m_data.currentFileModified||self.m_data.currentFileSaving)return;self.m_data.currentFileSaving=!0;let el=$("#imageLoader").detach();self.m_data.editorSelector.append($(el)),await self.m_data.m_fs.save(self.m_data.currentFilename,self.getData()),self.m_data.currentFileSaving=!1,self.currentFileModified(!1),el=$("#imageLoader").detach(),$("#explorerSaveAsModal").append($(el)),$(window).trigger("afterEditorSave",[self.m_data.m_editor_name])}catch(err){console.log(err),self.m_data.currentFileSaving=!1}else self.m_data.m_fs.doSaveDlg()}classes.close=`${modifiedname}Close`,classes.open=`${modifiedname}Open`,classes.save=`${modifiedname}Save`,classes.saveAs=`${modifiedname}SaveAs`,classes.editorLabel=`${modifiedname}EditorLabel`,idsClose&&addClassToElements(idsClose,"close"),idsOpen&&addClassToElements(idsOpen,"open"),idsSave&&addClassToElements(idsSave,"save"),idsSaveAs&&addClassToElements(idsSaveAs,"saveAs"),idEditorLabel&&addClassToElements(idEditorLabel,"editorLabel"),$(window).bind("fileSaved",(function(e,filename,editorName){editorName===self.m_data.name&&(self.m_data.currentFileSaving=!1,self.currentFileModified(!1),$(`.${classes.save}`).attr("disabled",!0),$(`.${classes.editorLabel}`).html(self.m_data.currentFilename+" - Mongo Notepad"),console.log("Saved"))})),$(window).bind("fileOpened",(function(e,data,filename,ext,editorName){editorName===self.m_data.name&&(self.m_data.currentFilename=filename)})),this.currentFileModified=function(modified){if(void 0===modified)return self.m_data.currentFileModified;if(self.m_data.currentFileModified=modified,modified){let title=$(`.${classes.editorLabel}`).html();title&&"*"!==title.charAt(0)&&$(`.${classes.editorLabel}`).html(`*${title}`),self.currentFilename()&&$(`.${classes.save}`).attr("disabled",!1)}},this.editorOpened=function(opened){if(void 0===opened)return self.m_data.m_editor_opened;self.m_data.m_editor_opened=opened,opened||(self.m_data.m_fs.currentFilename(null),self.currentFileModified(!1),self.currentFilename(null))},this.currentFilename=function(filename){if(void 0===filename)return self.m_data.currentFilename;self.m_data.currentFilename=filename},this.save=function(){return $("#explorerSaveAsModal").attr("editorName",self.m_data.name),doSave(),!0},this.saveAs=function(){self.setExplorerDlgParent(self.m_data.editorSelector),$("#explorerSaveAsModal").attr("editorName",self.m_data.name),self.m_data.m_fs.doSaveDlg()},this.getExtensions=function(){return extensions},this.setExplorerDlgParent=function(parent){let el=$("#explorerSaveAsModal").detach();parent.append($(el))},this.resetEditor=function(){self.closeEditor&&self.closeEditor(),self.setExplorerDlgParent($("body")),self.editorOpened(!1)},this.editorClose=function(exitingFile=!1){const fname=self.m_data.currentFilename||"Untitled";if(self.currentFileModified()){const ans=confirm(`Do you want to save changes to ${fname}.`);if(ans)return void(exitingFile&&"Untitled"!=fname?($(`.${classes.save}`).click(),self.resetEditor()):(saveAsFromClose=!0,$(`.${classes.saveAs}`).click()))}self.resetEditor()},$(`.${classes.open}`).click((function(){self.openFile()})),$(`.${classes.saveAs}`).click((function(){self.saveAs()})),$(`.${classes.save}`).click((function(){self.save()}));let saveAsFromClose=!1;$(window).bind("afterEditorSaveAs",(function(e,filename,editorName){editorName===self.m_data.name&&(saveAsFromClose?(self.closeEditor&&self.closeEditor(),self.setExplorerDlgParent($("body")),self.editorOpened(!1),saveAsFromClose=!1):($(`.${classes.editorLabel}`).html(filename+" - Mongo Notepad"),self.currentFilename(filename)))})),$(`.${classes.close}`).click((function(){self.editorClose()}))}initEditor(){$("#notepadSave").attr("disabled",!0),$("#notepadModalLabel").html("Untitled - Mongo Notepad"),this.editorOpened(!0),this.setExplorerDlgParent($("body"))}openFile(){this.setExplorerDlgParent(this.m_data.editorSelector),$("#explorerSaveAsModal").attr("editorName",this.m_data.name),this.m_data.m_fs.doExplorerDlg()}getData(){console.error("getData (): Not re-implemented.")}setData(data,filename,ext,editorName){}}class MongoNotepad extends Editor{constructor(obj){super(obj);const self=this;$(window).bind("fileSaved",(function(e,filename,editorName){editorName===self.m_data.name&&$("#myNotepad").focus()})),$("#myNotepad").on("input",(function(){self.currentFileModified(!0)}))}initEditor(){$("#myNotepad")[0].value=""}openEditor(){super.initEditor(),this.initEditor(),$("#notepadModal").modal("show")}closeEditor(){$("#notepadModal").modal("hide")}getData(){return $("#myNotepad").val()}setData(data,filename){this.editorOpened()||this.openEditor(),this.currentFilename(filename),$("#myNotepad")[0].value=data,$("#notepadModalLabel").html(filename+" - Mongo Notepad")}}class ChooseEditor{constructor(){const self=this,choiceStore={};let initialized=!1;function addToChooseEditorModal(editorName,checked=!1){const valueName=editorName.replaceAll(" ","-");checked?$("#chooseEditorTable").append($('<label><input type="radio" name="ChooseEditor" value='+valueName+" checked>"+editorName+"</label><br>")):$("#chooseEditorTable").append($('<label><input type="radio" name="ChooseEditor" value='+valueName+">"+editorName+"</label><br>"))}function init(editors){for(let i=0;i<editors.length;++i)addToChooseEditorModal(editors[i].editor.m_data.name,0==i);initialized=!0}this.doChooseEditorByExt=function(editors,ext){return new Promise((resolve,reject)=>{$("#chooseEditorOk").click((function(){delete choiceStore[ext];var radioValue=$("input[name='ChooseEditor']:checked").val();if(radioValue){radioValue=radioValue.replaceAll("-"," ");for(let i=0;i<editors.length;++i)if(editors[i].name===radioValue)return $("#alwaysUse")[0].checked&&(choiceStore[ext]=editors[i].editor),$("#chooseEditorModal").modal("hide"),resolve(editors[i].editor)}return $("#chooseEditorModal").modal("hide"),reject(null)})),$("#alwaysUseLabel").html(`Always use this app to open ${ext} fles`),$("#chooseEditorModal").modal("show")})},this.chooseEditorByExt=function(editors,ext){return new Promise(async(resolve,reject)=>{initialized||init(editors);try{const edt=await self.doChooseEditorByExt(editors,ext);resolve(edt)}catch(err){reject(err)}})},this.getEditorStoredChoice=function(ext){return choiceStore[ext]||null},this.getEditorByExt=function(editors,ext){return new Promise(async(resolve,reject)=>{const storedEditor=choiceStore[ext]||null;if(storedEditor)return resolve(storedEditor);initialized||init(editors);let availableEditors=[];for(let i=0;i<editors.length;++i){const editor=editors[i].editor,exts=editor.getExtensions();for(let n=0;n<exts.length;++n)exts[n]==ext&&availableEditors.push(editor)}if(0==availableEditors.length)return resolve(null);if(1==availableEditors.length)return resolve(availableEditors[0]);try{const edt=await self.doChooseEditorByExt(editors,ext);resolve(edt)}catch(err){reject(err)}})}}}